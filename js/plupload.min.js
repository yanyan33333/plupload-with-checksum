/**
 * Plupload - multi-runtime File Uploader
 * v2.0a
 *
 * Copyright 2013, Moxiecode Systems AB
 * Released under GPL License.
 *
 * License: http://www.plupload.com/license
 * Contributing: http://www.plupload.com/contributing
 *
 * Date: 2012-11-30
 */
;(function(e,t,n){var r=e.setTimeout,s={VERSION:"2.0a",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,FILE_DUPLICATE_ERROR:-602,IMAGE_FORMAT_ERROR:-700,IMAGE_MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,mimeTypes:t.mimes,ua:t.ua,typeOf:t.typeOf,extend:t.extend,guid:t.guid,each:t.each,getPos:t.getPos,getSize:t.getSize,xmlEncode:function(e){var t={"<":"lt",">":"gt","&":"amp",'"':"quot","'":"#39"},n=/[<>&\"\']/g;return e?(""+e).replace(n,function(e){return t[e]?"&"+t[e]+";":e}):e},toArray:t.toArray,inArray:t.inArray,addI18n:t.addI18n,translate:t.translate,isEmptyObj:t.isEmptyObj,hasClass:t.hasClass,addClass:t.addClass,removeClass:t.removeClass,getStyle:t.getStyle,addEvent:t.addEvent,removeEvent:t.removeEvent,removeAllEvents:t.removeAllEvents,cleanName:function(e){var t,n;n=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,"U",/[\371-\374]/g,"u"];for(t=0;t<n.length;t+=2)e=e.replace(n[t],n[t+1]);return e=e.replace(/\s+/g,"_"),e=e.replace(/[^a-z0-9_\-\.]+/gi,""),e},buildUrl:function(e,t){var n="";return s.each(t,function(e,t){n+=(n?"&":"")+encodeURIComponent(t)+"="+encodeURIComponent(e)}),n&&(e+=(e.indexOf("?")>0?"&":"?")+n),e},formatSize:function(e){return e===n||/\D/.test(e)?s.translate("N/A"):e>1073741824?Math.round(e/1073741824,1)+" GB":e>1048576?Math.round(e/1048576,1)+" MB":e>1024?Math.round(e/1024,1)+" KB":e+" b"},parseSize:t.parseSizeStr};s.Uploader=function(e){function y(){var e,t=0,n;if(this.state==s.STARTED){for(n=0;n<u.length;n++)!e&&u[n].status==s.QUEUED?(e=u[n],this.trigger("BeforeUpload",e)&&(e.status=s.UPLOADING,this.trigger("UploadFile",e))):t++;t==u.length&&(this.state!==s.STOPPED&&(this.state=s.STOPPED,this.trigger("StateChanged")),this.trigger("UploadComplete",u))}}function b(e){e.percent=e.size>0?Math.ceil(e.loaded/e.size*100):100,w()}function w(){var e,t;p.reset();for(e=0;e<u.length;e++)t=u[e],t.size!==n?(p.size+=t.origSize,p.loaded+=t.loaded*t.origSize/t.size):p.size=n,t.status==s.DONE?p.uploaded++:t.status==s.FAILED?p.failed++:p.queued++;p.size===n?p.percent=u.length>0?Math.ceil(p.uploaded/u.length*100):0:(p.bytesPerSec=Math.ceil(p.loaded/((+(new Date)-h||1)/1e3)),p.percent=p.size>0?Math.ceil(p.loaded/p.size*100):0)}function E(e){var t,n=[];for(t=0;t<e.length;t++)n.push(new s.File(e[t]));n.length&&this.trigger("FilesAdded",n)}function S(){var n=this,r=0;t.inSeries([function(i){e.browse_button?(v=new t.FileInput({accept:e.filters,runtime_order:e.runtimes,name:e.file_data_name,multiple:e.multi_selection,container:e.container,browse_button:e.browse_button,required_caps:l,swf_url:e.flash_swf_url,xap_url:e.silverlight_xap_url}),v.onready=function(){var e=t.Runtime.getInfo(this.ruid);t.extend(n.features,{chunks:e.can("slice_blob"),multipart:e.can("send_multipart"),multi_selection:e.can("select_multiple")}),r++,i()},v.onchange=function(){E.call(n,this.files)},v.bind("mouseenter mouseleave mousedown mouseup",function(n){if(!d){var r=t.get(e.browse_button);r&&(e.browse_button_hover&&("mouseenter"===n.type?t.addClass(r,e.browse_button_hover):"mouseleave"===n.type&&t.removeClass(r,e.browse_button_hover)),e.browse_button_active&&("mousedown"===n.type?t.addClass(r,e.browse_button_active):"mouseup"===n.type&&t.removeClass(r,e.browse_button_active)),r=null)}}),v.bind("error runtimeerror",function(){i()}),v.init()):i()},function(i){e.drop_element?(m=new t.FileDrop({drop_zone:e.drop_element,accept:e.filters,runtime_order:e.runtimes,required_caps:l,swf_url:e.flash_swf_url,xap_url:e.silverlight_xap_url}),m.onready=function(){var e=t.Runtime.getInfo(this.ruid);n.features.dragdrop=e.can("drag_and_drop"),r++,i()},m.ondrop=function(){E.call(n,this.files)},m.bind("error runtimeerror",function(){i()}),m.init()):i()}],function(t){r?(n.trigger("PostInit"),typeof e.init=="function"?e.init(n):s.each(e.init,function(e,t){n.bind(t,e)})):n.trigger("Error",{code:s.INIT_ERROR,message:s.translate("Init error.")})})}function x(e,n){if(e.ruid){var r=t.Runtime.getInfo(e.ruid);if(r)return r.can(n)}return!1}function T(e,n,r){var i=new t.Image;try{i.onload=function(){i.resize(n.width,n.height,n.crop,n.preserve_headers)},i.onresize=function(){r(this.getAsBlob(e.type,n.quality)),this.destroy()},i.onerror=function(){r(e)},i.load(e)}catch(s){r(e)}}var u=[],a={},f=[],l={},c={},h,p,d=!1,v,m,g;p=new s.QueueProgress,e=s.extend({chunk_size:0,max_retries:0,multipart:!0,multi_selection:!0,file_data_name:"file",filters:[],prevent_duplicates:!1},e),e.resize&&(e.resize=s.extend({preserve_headers:!0,crop:!1},e.resize)),c={chunks:"slice_blob",resize:"send_binary_string",jpgresize:"send_binary_string",pngresize:"send_binary_string",multipart:"send_multipart",progress:"report_upload_progress",multi_selection:"select_multiple",canSendBinary:"send_binary"},typeof e.required_features=="string"&&(f=e.required_features.split(/\s*,\s*/)),f.length&&s.each(f,function(e){c[e]?l[c[e]]=!0:l[e]=!0}),e.multipart||(l.send_binary_string=!0),s.extend(this,{id:s.guid(),state:s.STOPPED,features:{},files:u,settings:e,total:p,init:function(){var a=this;e.chunk_size=s.parseSize(e.chunk_size),e.max_file_size=s.parseSize(e.max_file_size),e.drop_element=t.get(e.drop_element),typeof e.preinit=="function"?e.preinit(a):s.each(e.preinit,function(e,t){a.bind(t,e)}),a.bind("FilesAdded",function(t,i){var o,f,l,c=0,h,p=e.filters;p&&p.length&&(h=[],s.each(p,function(e){s.each(e.extensions.split(/,/),function(e){/^\s*\*\s*$/.test(e)?h.push("\\.*"):h.push("\\."+e.replace(new RegExp("["+"/^$.*+?|()[]{}\\".replace(/./g,"\\$&")+"]","g"),"\\$&"))})}),h=new RegExp("("+h.join("|")+")$","i"));e:for(o=0;o<i.length;o++){l=i[o],l.loaded=0,l.percent=0,l.status=s.QUEUED;if(h&&!h.test(l.name)){t.trigger("Error",{code:s.FILE_EXTENSION_ERROR,message:s.translate("File extension error."),file:l});continue}if(l.size!==n&&l.size>e.max_file_size){t.trigger("Error",{code:s.FILE_SIZE_ERROR,message:s.translate("File size error."),file:l});continue}if(e.prevent_duplicates){f=t.files.length;while(f--)if(l.name===t.files[f].name&&l.size===t.files[f].size){t.trigger("Error",{code:s.FILE_DUPLICATE_ERROR,message:s.translate("Duplicate file error."),file:l});continue e}}u.push(l),c++}if(!c)return!1;r(function(){a.trigger("QueueChanged"),a.refresh()},1)}),a.bind("CancelUpload",function(){g&&g.abort()}),e.unique_names&&a.bind("UploadFile",function(e,t){var n=t.name.match(/\.([^.]+)$/),r="part";n&&(r=n[1]),t.target_name=t.id+"."+r}),a.bind("UploadFile",function(n,i){function d(){c-->0?r(v,1):(i.loaded=p,n.trigger("Error",{code:s.HTTP_ERROR,message:s.translate("HTTP Error."),file:i,status:g.status}))}function v(){var c,m,y,b;if(i.status==s.DONE||i.status==s.FAILED||n.state==s.STOPPED)return;y={name:i.target_name||i.name},f&&a.chunks&&h.size>f?(b=Math.min(e.chunk_size,h.size-p),c=h.slice(p,p+b),y.offset=p,y.total=h.size):(b=h.size,c=h),g=new t.XMLHttpRequest,g.upload&&(g.upload.onprogress=function(e){i.loaded=Math.min(i.size,p+e.loaded),n.trigger("UploadProgress",i)}),g.onload=function(){if(g.status>=400){d();return}b<h.size?(c.destroy(),p+=b,i.loaded=Math.min(p,h.size),chunkArgs={offset:i.loaded,total:h.size,response:g.responseText,status:g.status},n.trigger("ChunkUploaded",i,chunkArgs)):i.loaded=i.size,n.trigger("UploadProgress",i),c=m=null,!p||p>=h.size?(i.size!=i.origSize&&(h.destroy(),h=null),i.status=s.DONE,n.trigger("FileUploaded",i,{response:g.responseText,status:g.status})):r(v,1)},g.onerror=function(){d()},g.onloadend=function(){this.destroy(),g=null},n.settings.multipart&&a.multipart?(y.name=i.target_name||i.name,g.open("post",u,!0),s.each(n.settings.headers,function(e,t){g.setRequestHeader(t,e)}),m=new t.FormData,s.each(s.extend(y,n.settings.multipart_params),function(e,t){m.append(t,e)}),m.append(n.settings.file_data_name,c),g.send(m,{runtime_order:n.settings.runtimes,required_caps:l,swf_url:n.settings.flash_swf_url,xap_url:n.settings.silverlight_xap_url})):(u=s.buildUrl(n.settings.url,s.extend(y,n.settings.multipart_params)),g.open("post",u,!0),g.setRequestHeader("Content-Type","application/octet-stream"),s.each(n.settings.headers,function(e,t){g.setRequestHeader(t,e)}),g.send(c,{runtime_order:n.settings.runtimes,required_caps:l,swf_url:n.settings.flash_swf_url,xap_url:n.settings.silverlight_xap_url}))}var u=n.settings.url,a=n.features,f=e.chunk_size,c=e.max_retries,h,p=0;i.loaded&&(p=i.loaded=f*Math.floor(i.loaded/f)),h=i.getSource(),!t.isEmptyObj(n.settings.resize)&&x(h,"send_binary_string")&&!!~t.inArray(h.type,["image/jpeg","image/png"])?T.call(this,h,n.settings.resize,function(e){h=e,i.size=e.size,v()}):v()}),a.bind("UploadProgress",function(e,t){b(t)}),a.bind("StateChanged",function(e){if(e.state==s.STARTED)h=+(new Date);else if(e.state==s.STOPPED)for(i=e.files.length-1;i>=0;i--)e.files[i].status==s.UPLOADING&&(e.files[i].status=s.QUEUED,w())}),a.bind("QueueChanged",w),a.bind("Error",function(e,t){t.file&&(t.file.status=s.FAILED,b(t.file),e.state==s.STARTED&&r(function(){y.call(a)},1))}),a.bind("FileUploaded",function(e,t){t.status=s.DONE,t.loaded=t.size,b(t),r(function(){y.call(a)},1)}),a.trigger("Init",{runtime:"Generic"}),S.call(this)},refresh:function(){v.trigger("Refresh"),this.trigger("Refresh")},start:function(){this.state!=s.STARTED&&(this.state=s.STARTED,this.trigger("StateChanged"),y.call(this))},stop:function(){this.state!=s.STOPPED&&(this.state=s.STOPPED,this.trigger("StateChanged"),this.trigger("CancelUpload"))},disableBrowse:function(){d=arguments[0]!==n?arguments[0]:!0,v&&v.disable(d),this.trigger("DisableBrowse",d)},getFile:function(e){var t;for(t=u.length-1;t>=0;t--)if(u[t].id===e)return u[t]},addFile:function(e){function u(e){var a=t.typeOf(e);if(e instanceof t.Blob)r.push(e);else{if(a==="file"){i.push(function(r){var i=new t.RuntimeTarget;i.bind("RuntimeInit",function(n,i){u(new t.File(i.uid,e)),r()});try{i.connectRuntime({runtime_order:"html5"})}catch(a){n.trigger("Error",{code:s.FILE_EXTENSION_ERROR,message:s.translate("File extension error."),file:e}),r()}});return}a==="node"&&t.typeOf(e.files)==="filelist"?t.each(e.files,u):a==="array"&&t.each(e,u)}}var n=this,r=[],i=[];u(e),t.inSeries(i,function(){E.call(n,r)})},removeFile:function(e){var t;for(t=u.length-1;t>=0;t--)if(u[t].id===e.id)return this.splice(t,1)[0]},splice:function(e,t){var r;return r=u.splice(e===n?0:e,t===n?u.length:t),this.trigger("FilesRemoved",r),this.trigger("QueueChanged"),s.each(r,function(e){e.destroy()}),r},trigger:function(e){var t=a[e.toLowerCase()],n,r;if(t){r=Array.prototype.slice.call(arguments),r[0]=this;for(n=0;n<t.length;n++)if(t[n].func.apply(t[n].scope,r)===!1)return!1}return!0},hasEventListener:function(e){return!!a[e.toLowerCase()]},bind:function(e,t,n){var r;e=e.toLowerCase(),r=a[e]||[],r.push({func:t,scope:n||this}),a[e]=r},unbind:function(e){e=e.toLowerCase();var t=a[e],r,i=arguments[1];if(t){if(i!==n){for(r=t.length-1;r>=0;r--)if(t[r].func===i){t.splice(r,1);break}}else t=[];t.length||delete a[e]}},unbindAll:function(){var e=this;s.each(a,function(t,n){e.unbind(n)})},destroy:function(){this.stop(),this.trigger("Destroy"),this.unbindAll()}})},s.File=function(){function t(t){s.extend(this,{id:s.guid(),name:t.name||t.fileName,type:t.type||"",size:t.size||t.fileSize,origSize:t.size||t.fileSize,loaded:0,percent:0,status:0,getSource:function(){return e[this.id]?e[this.id]:null},destroy:function(){var t=this.getSource();t&&(t.destroy(),delete e[this.id])}}),e[this.id]=t}var e={};return t}(),s.QueueProgress=function(){var e=this;e.size=0,e.loaded=0,e.uploaded=0,e.failed=0,e.queued=0,e.percent=0,e.bytesPerSec=0,e.reset=function(){e.size=e.loaded=e.uploaded=e.failed=e.queued=e.percent=e.bytesPerSec=0}},e.plupload=s})(window,mOxie);